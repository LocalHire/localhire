<div class="show-main">
  <p id="notice"><%= notice %></p>
  <p>
    <strong>Name:</strong>
    <%= @item.name %>
  </p>
  <p>
    <strong>Description:</strong>
    <%= @item.description %>
  </p>
  <p>
    <strong>Instructions:</strong>
    <%= @item.instructions %>
  </p>

  <p>
    <%(0...@item.images.count).each do |image|%>
      <%=image_tag @item.images[image], width: '200', height: '200'%>
    <%end%>
  </p>

  <%# <%= link_to 'Edit', edit_item_path(@item) | %>
  <%= link_to 'Back', items_path %>

</div>


<%= form_tag charges_path, id: 'stripe-form' do %>
  <label for="price">Book this <%= @item.name %></label>
  <br>
  <select id="durationForHire" name="duration_for_hire">
    <option selected="selected">Select the $ / timeframe</option>
    
    <% unless @item.price_per_hour.nil? %>
      <option 
        data-price="<%= @item.price_per_hour %>" 
        data-max="<%= @item.max_hours_per_hire %>" 
        value='hour'>
          $ <%= @item.price_per_hour %> per hour
        </option>
    <% end %>

    <% unless @item.price_per_day.nil? %>
      <option 
        data-price="<%= @item.price_per_day %>" 
        data-max="<%= @item.max_days_per_hire %>" 
        value='day'>
        $ <%= @item.price_per_day %> per day
        </option>
    <% end %>

    <% unless @item.price_per_week.nil? %>
      <option 
        data-price="<%= @item.price_per_week %>"
        data-max="<%= @item.max_weeks_per_hire %>"
         value='week'>
        $ <%= @item.price_per_week %> per week
        </option>
    <% end %>
    
  </select>

  
  <label id="durationLabel" for="duration"></label> <!-- I removed the following between the label tags, but we can put it back if preferred - How long would you like to borrow this item for? -->

  <div id="slidecontainer">
    <input id="durationInput" name="duration" type="range" min="1" max="100" value="50" class="slider" id="myRange">
  </div>
  
  <%# <input id="durationInput" name="duration" type="number" min="1"> <!-- max="1" --> %>
  <%# </p> %>


  <article>
    <% if flash[:error].present? %>
      <div id="error_explanation">
        <p><%= flash[:error] %></p>
      </div>
    <% end %>
  </article>


  <p>
    <strong>Total Booking Cost: $</strong>
    <span id="total"></span>
  </p>
  <input type="hidden" id="stripeToken" name="stripeToken">
  <input type="hidden" id="stripeEmail" name="stripeEmail">
  <input type="hidden" name="item_id" value="<%= @item.id %>">

  <button id="pay">Make a Booking </button>

  
<% end %>

  <script src="https://checkout.stripe.com/checkout.js"></script>

  <script>
  var durationForHire = document.getElementById("durationForHire")
  var durationLabel = document.getElementById("durationLabel")
  var durationInput = document.getElementById("durationInput")
  var totalText = document.getElementById('total')

  var durationMax, durationPrice = 0;

  durationForHire.addEventListener("change", updateForm)
  durationInput.addEventListener("change", updateTotal)

  function updateTotal(event) {
    durationPrice = durationForHire.options[durationForHire.selectedIndex].dataset.price
    totalText.innerText = durationPrice * event.target.value
  }

  function updateForm(event) {
      var durationChoice = event.target.value
      durationMax = event.target.options[event.target.selectedIndex].dataset.max
      durationPrice = event.target.options[event.target.selectedIndex].dataset.price
      var label = ""

      // this stops the input from going over the maximum
      durationInput.max = durationMax
      totalText.innerText = durationPrice *  durationInput.value
      console.log(durationPrice, durationInput.value)

      switch (durationChoice) {
        case "week":
          label = "You can borrow this item for up to <%= @item.max_weeks_per_hire %> weeks.  How many weeks do you want to borrow it for?";
          
          break
        case "day":
          label = "You can borrow this item for up to <%= @item.max_days_per_hire %> days.  How many days do you want this for?";
          break
        case "hour":
          label = "You can borrow this item for up to <%= @item.max_hours_per_hire %> hours.  How many hours do you want this for?";
          break
        default:
          label = "Please pick a duration from the dropdown";
      }
    
    durationLabel.innerText = label
    
  }

// Init Stripe with our key
var handler = StripeCheckout.configure({
  key: "<%= Rails.configuration.stripe[:publishable_key] %>",
  token: function(token) {
    // Got the token!
    // Update our form
    $("#stripeToken").val(token.id);
    $("#stripeEmail").val(token.email);
    // And submit our form
    $("#stripe-form").submit();
  }
});

// This listens for the user to click on the pay button
$('#pay').on('click', function(e) {
  // This gets the total amount and opens the stripe window
  var amountInCents =  parseInt($('#total').html(),10) * 100;
  handler.open({
    name: "<%= @item.name %>",
    amount: amountInCents,
    currency:"AUD",
    locale:"auto"
  });
  e.preventDefault();
});

// This closes the Checkout on page navigation
$(window).on('popstate', function() {
  handler.close();
});

</script>


